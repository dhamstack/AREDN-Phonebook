#!/bin/sh
# Simple UDP LAN-to-LAN test - continuous packet sender
# Usage: test-udp-lan <destination_ip> [interval_ms]

if [ -z "$1" ]; then
    echo "Usage: test-udp-lan <destination_ip> [interval_ms]"
    echo "Example: test-udp-lan 10.51.55.233 100"
    echo "         (sends packets every 100ms until Ctrl+C)"
    exit 1
fi

DST="$1"
INTERVAL="${2:-100}"  # Default 100ms
PORT=40050

# Get our LAN IP
SRC=$(ip -4 addr show br-lan | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)

echo "=== UDP LAN Continuous Test ==="
echo "Source: $SRC"
echo "Destination: $DST:$PORT"
echo "Interval: ${INTERVAL}ms"
echo "Press Ctrl+C to stop"
echo ""

# Test basic connectivity first
echo "Testing connectivity..."
ping -c 2 -W 2 $DST > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ Ping successful"
else
    echo "✗ Ping failed"
fi

echo ""
echo "Route: $(ip route get $DST | head -1)"
echo ""
echo "Sending packets..."

# Send packets continuously
SEQ=0
while true; do
    TIMESTAMP=$(date +%s.%N 2>/dev/null || date +%s)
    echo "SEQ=$SEQ TIME=$TIMESTAMP SRC=$SRC DST=$DST" | nc -u -w1 $DST $PORT 2>&1
    echo "[$TIMESTAMP] Sent packet $SEQ"
    SEQ=$((SEQ + 1))
    usleep $((INTERVAL * 1000))
done
