#!/bin/sh
# SIP OPTIONS test - continuous SIP health checks from simulated phone
# Usage: test-udp-lan <source_phone_ip> <destination_phone_ip> [interval_ms]

if [ -z "$2" ]; then
    echo "Usage: test-udp-lan <source_phone_ip> <destination_phone_ip> [interval_ms]"
    echo "Example: test-udp-lan 10.197.143.20 10.51.55.238 1000"
    echo "         (10.197.143.20 sends OPTIONS to 10.51.55.238 every 1000ms)"
    exit 1
fi

SRC="$1"
DST="$2"
INTERVAL="${3:-1000}"  # Default 1000ms for SIP
PORT=5060  # SIP port

# Get hostname
HOSTNAME=$(cat /proc/sys/kernel/hostname)

# Add source IP as alias to br-lan (if not already there)
ip addr show br-lan | grep -q "$SRC" || {
    echo "Adding $SRC as alias to br-lan..."
    ip addr add $SRC/32 dev br-lan
}

echo "=== SIP OPTIONS Test (Phone-to-Phone) ==="
echo "Source Phone: $SRC ($HOSTNAME)"
echo "Destination Phone: $DST:$PORT"
echo "Interval: ${INTERVAL}ms"
echo "Press Ctrl+C to stop"
echo ""

# Cleanup on exit
trap "echo ''; echo 'Removing IP alias...'; ip addr del $SRC/32 dev br-lan 2>/dev/null; exit" INT TERM

# Test basic connectivity first
echo "Testing connectivity..."
ping -c 2 -W 2 $DST > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ Ping successful"
else
    echo "✗ Ping failed"
fi

echo ""
echo "Route: $(ip route get $DST | head -1)"
echo ""
echo "Sending SIP OPTIONS packets..."

# Send SIP OPTIONS continuously
SEQ=0
while true; do
    TIMESTAMP=$(date +%s)
    CALLID="monitor-${HOSTNAME}-${TIMESTAMP}-${SEQ}"

    # Create SIP OPTIONS packet
    SIP_PACKET="OPTIONS sip:phonebook@${DST}:${PORT} SIP/2.0
Via: SIP/2.0/UDP ${SRC}:${PORT};branch=z9hG4bK${SEQ}
From: <sip:monitor@${SRC}>;tag=monitor${SEQ}
To: <sip:phonebook@${DST}>
Call-ID: ${CALLID}
CSeq: ${SEQ} OPTIONS
Contact: <sip:monitor@${SRC}:${PORT}>
Max-Forwards: 70
User-Agent: AREDN-Monitor/1.0
Content-Length: 0

"

    echo "$SIP_PACKET" | nc -u -w1 $DST $PORT 2>&1
    echo "[$TIMESTAMP] Sent OPTIONS #$SEQ (Call-ID: $CALLID)"
    SEQ=$((SEQ + 1))
    usleep $((INTERVAL * 1000))
done
