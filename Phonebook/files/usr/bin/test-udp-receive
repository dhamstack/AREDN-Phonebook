#!/bin/sh
# SIP OPTIONS receiver and responder - simulates a phone
# Usage: test-udp-receive <phone_ip> [port]

if [ -z "$1" ]; then
    echo "Usage: test-udp-receive <phone_ip> [port]"
    echo "Example: test-udp-receive 10.51.55.238"
    echo "         (simulates a phone at 10.51.55.238:5060)"
    exit 1
fi

PHONE_IP="$1"
PORT="${2:-5060}"

# Get hostname
HOSTNAME=$(cat /proc/sys/kernel/hostname)

# Add the phone IP as an alias to br-lan (if not already there)
ip addr show br-lan | grep -q "$PHONE_IP" || {
    echo "Adding $PHONE_IP as alias to br-lan..."
    ip addr add $PHONE_IP/32 dev br-lan
}

echo "=== SIP OPTIONS Receiver Test (Phone Simulator) ==="
echo "Phone IP: $PHONE_IP:$PORT"
echo "Node: $HOSTNAME"
echo "Will respond with SIP 200 OK to OPTIONS requests"
echo "Press Ctrl+C to stop"
echo ""

# Cleanup on exit
trap "echo ''; echo 'Removing IP alias...'; ip addr del $PHONE_IP/32 dev br-lan 2>/dev/null; exit" INT TERM

# Listen for SIP packets and respond
while true; do
    # Receive packet and save to temp file
    nc -l -u -p $PORT > /tmp/sip-packet.txt 2>&1

    TIMESTAMP=$(date +%Y-%m-%d_%H:%M:%S)

    # Parse SIP packet
    METHOD=$(head -1 /tmp/sip-packet.txt | awk '{print $1}')
    CALLID=$(grep "^Call-ID:" /tmp/sip-packet.txt | cut -d: -f2- | tr -d ' \r')
    CSEQ=$(grep "^CSeq:" /tmp/sip-packet.txt | cut -d: -f2- | tr -d ' \r')
    FROM=$(grep "^From:" /tmp/sip-packet.txt | cut -d: -f2- | tr -d '\r')
    TO=$(grep "^To:" /tmp/sip-packet.txt | cut -d: -f2- | tr -d '\r')
    VIA=$(grep "^Via:" /tmp/sip-packet.txt | cut -d: -f2- | tr -d '\r')

    echo "[$TIMESTAMP] Received $METHOD"
    echo "  Call-ID: $CALLID"
    echo "  From: $FROM"
    echo "  CSeq: $CSEQ"

    # If it's OPTIONS, send 200 OK response
    if [ "$METHOD" = "OPTIONS" ]; then
        echo "  â†’ Responding with 200 OK"

        # Extract source IP from Via header (simplified)
        SRC_IP=$(echo "$VIA" | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1)

        if [ -n "$SRC_IP" ]; then
            # Create SIP 200 OK response from phone IP
            SIP_RESPONSE="SIP/2.0 200 OK
Via:$VIA
From:$FROM
To:$TO
Call-ID: $CALLID
CSeq: $CSEQ
Contact: <sip:phone@${PHONE_IP}:${PORT}>
User-Agent: AREDN-Test-Phone/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE
Content-Length: 0

"
            echo "$SIP_RESPONSE" | nc -u -w1 $SRC_IP $PORT 2>&1
        fi
    fi

    echo ""
done
