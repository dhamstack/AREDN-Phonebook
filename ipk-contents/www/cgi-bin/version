#!/bin/sh

# AREDN Phonebook Version Endpoint
# Returns version information in JSON format

echo "Content-Type: application/json"
echo "Cache-Control: no-cache"
echo ""

# Get version from package info or binary
VERSION="unknown"
if [ -f "/usr/lib/opkg/info/aredn-phonebook.control" ]; then
    VERSION=$(grep "^Version:" /usr/lib/opkg/info/aredn-phonebook.control | cut -d' ' -f2)
fi

# Try binary --version if package info not available
if [ "$VERSION" = "unknown" ] && [ -f "/usr/bin/aredn-phonebook" ]; then
    VERSION=$(/usr/bin/aredn-phonebook --version 2>/dev/null | head -1 | awk '{print $3}')
    if [ -z "$VERSION" ]; then
        VERSION="unknown"
    fi
fi

# Get hostname
HOSTNAME=$(cat /proc/sys/kernel/hostname 2>/dev/null || echo "unknown")

# Get uptime
UPTIME=$(awk '{print int($1)}' /proc/uptime 2>/dev/null || echo "0")

# Check if process is running
if pgrep -f "aredn-phonebook" > /dev/null 2>&1; then
    RUNNING="true"
    PID=$(pgrep -f "aredn-phonebook" | head -1)
else
    RUNNING="false"
    PID="null"
fi

# Generate JSON
cat << EOF
{
  "version": "$VERSION",
  "node": "$HOSTNAME",
  "running": $RUNNING,
  "pid": $PID,
  "system_uptime": $UPTIME,
  "features": {
    "phonebook": true,
    "health_monitoring": true,
    "crash_reporting": true,
    "network_monitoring": false
  }
}
EOF