#!/bin/sh

# AREDN Phonebook Health Check Endpoint
# Returns JSON health status for monitoring and diagnostics

echo "Content-Type: application/json"
echo "Cache-Control: no-cache"
echo ""

# Check if AREDN-Phonebook process is running
PID=$(pgrep -f "aredn-phonebook")
if [ -z "$PID" ]; then
    echo '{"status":"error","message":"AREDN-Phonebook process not found","timestamp":"'$(date -Iseconds)'"}'
    exit 1
fi

# Get process information
RSS_KB=$(awk '/VmRSS:/ {print $2}' /proc/$PID/status 2>/dev/null || echo "0")
PEAK_KB=$(awk '/VmPeak:/ {print $2}' /proc/$PID/status 2>/dev/null || echo "0")
SIZE_KB=$(awk '/VmSize:/ {print $2}' /proc/$PID/status 2>/dev/null || echo "0")
THREADS=$(ls /proc/$PID/task/ 2>/dev/null | wc -l || echo "0")

# Convert to MB for readability
RSS_MB=$(echo "scale=1; $RSS_KB / 1024" | bc 2>/dev/null || echo "0")
PEAK_MB=$(echo "scale=1; $PEAK_KB / 1024" | bc 2>/dev/null || echo "0")
SIZE_MB=$(echo "scale=1; $SIZE_KB / 1024" | bc 2>/dev/null || echo "0")

# Get uptime
STARTED=$(stat -c %Y /proc/$PID 2>/dev/null || echo "0")
NOW=$(date +%s)
UPTIME=$((NOW - STARTED))

# Check if SIP port is listening
SIP_PORT_ACTIVE=$(netstat -tulpn 2>/dev/null | grep ":5060.*$PID/" | wc -l)

# Check thread responsiveness by looking at recent log activity
RECENT_LOGS=$(logread | grep -c "AREDN-Phonebook\[$PID\]" | tail -10 | wc -l)

# Determine overall health status
HEALTH_SCORE=100

if [ "$THREADS" -lt 4 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 20))
fi

if [ "$SIP_PORT_ACTIVE" -eq 0 ]; then
    HEALTH_SCORE=$((HEALTH_SCORE - 30))
fi

if [ "$RSS_KB" -gt 2048 ]; then  # More than 2MB might indicate issues
    HEALTH_SCORE=$((HEALTH_SCORE - 10))
fi

# Determine status based on health score
if [ "$HEALTH_SCORE" -ge 80 ]; then
    STATUS="healthy"
elif [ "$HEALTH_SCORE" -ge 60 ]; then
    STATUS="degraded"
else
    STATUS="critical"
fi

# Generate JSON response
cat << EOF
{
    "status": "$STATUS",
    "timestamp": "$(date -Iseconds)",
    "health_score": $HEALTH_SCORE,
    "uptime_seconds": $UPTIME,
    "process": {
        "pid": $PID,
        "threads": $THREADS,
        "memory": {
            "rss_mb": $RSS_MB,
            "peak_mb": $PEAK_MB,
            "size_mb": $SIZE_MB
        }
    },
    "services": {
        "sip_port_active": $([ "$SIP_PORT_ACTIVE" -gt 0 ] && echo "true" || echo "false"),
        "recent_activity": $([ "$RECENT_LOGS" -gt 0 ] && echo "true" || echo "false")
    },
    "checks": {
        "process_running": true,
        "threads_active": $([ "$THREADS" -ge 4 ] && echo "true" || echo "false"),
        "memory_stable": $([ "$RSS_KB" -le 2048 ] && echo "true" || echo "false"),
        "sip_service_ok": $([ "$SIP_PORT_ACTIVE" -gt 0 ] && echo "true" || echo "false")
    }
}
EOF